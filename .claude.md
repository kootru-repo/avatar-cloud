# Gemini Live Avatar - Claude Code Instructions

Voice-to-voice AI avatar using Gemini 2.5 Flash Live API with native audio streaming.

**Architecture:** Vanilla JS frontend ‚Üí Python backend proxy ‚Üí Gemini Live API
**Deployment Details:** See `CLAUDE_DEPLOYMENT_GUIDE.md`

---

## üî¥ CRITICAL: ALWAYS USE THIS MODEL

**MODEL NAME (NEVER CHANGE):**
```
models/gemini-2.5-flash-native-audio-preview-09-2025
```

**API TYPE (NEVER CHANGE):**
- Google AI Developer API (NOT Vertex AI)
- Authentication: API Key (NOT Service Account)
- API Version: v1alpha

**This applies to ALL files:**
- Configuration files (frontend_config.json, backend_config.json)
- Backend code (gemini_client.py, config files)
- Frontend code (app.js, frontend_config.json)
- Test scripts
- Documentation

**No exceptions. No variations. Always this exact model name and API.**

---

## ‚ö†Ô∏è IMPORTANT: Documentation Policy

**DO NOT create summary documents or reports for:**
- Code fixes, bug fixes, or refactoring work
- Problems solved or issues resolved
- Security patches or testing results

**Examples of documents NOT to create:**
- ‚ùå FIXES_IMPLEMENTED.md
- ‚ùå CHANGES_SUMMARY.md
- ‚ùå WORK_COMPLETED.md
- ‚ùå Any similar wrap-up documentation

**Why:** User tracks work through git commits. Summary docs clutter the project.

**What TO create:**
- ‚úÖ Code files (.js, .py, .html, .json)
- ‚úÖ Configuration files
- ‚úÖ Test files
- ‚úÖ Essential documentation updates (only if critical)

---

## ‚ö†Ô∏è CRITICAL: SDK Usage Policy

**ONLY use official Google Generative AI SDK methods and patterns.**

### Before Planning ANY Code Change:
1. **ALWAYS check latest SDK references first**
2. Verify method/pattern is officially supported
3. Do not invent custom protocols or workarounds
4. Follow exact SDK patterns from official examples

### SDK Reference:
- **Documentation:** https://googleapis.github.io/python-genai/
- **GitHub:** https://github.com/googleapis/python-genai
- **PyPI:** https://pypi.org/project/google-genai/
- **Version:** 1.51.0
- **Parameter Style:** snake_case (ALWAYS)

### Key SDK Findings:
- **Audio transmission:** Send with `audio=types.Blob(data=bytes, mime_type="audio/pcm")`
- **DO NOT** create custom turn-end detection if SDK doesn't use it
- **DO NOT** assume SDK features exist without verification
- Function calling uses `tool_call.function_calls` (plural array, NOT singular)

**If unsure whether a method is official:** Stop and verify against SDK docs.

---

## Code Style & Conventions

### JavaScript
- Use semicolons (project convention)
- `async/await` for asynchronous operations
- `const` and `let`, avoid `var`
- Class-based architecture for managers

### Python
- Type hints on function signatures
- `async/await` for all WebSocket operations
- f-strings for string formatting
- Descriptive logging with emojis for user-facing messages

### File Organization
```
frontend/
  ‚îú‚îÄ‚îÄ index.html               # Single page app
  ‚îú‚îÄ‚îÄ app.js                   # Main orchestration
  ‚îú‚îÄ‚îÄ audio-player.js          # Audio playback
  ‚îú‚îÄ‚îÄ audio-recorder.js        # Microphone + barge-in
  ‚îú‚îÄ‚îÄ frontend_config.json     # Frontend configuration
  ‚îî‚îÄ‚îÄ media/

backend/
  ‚îú‚îÄ‚îÄ main.py                  # WebSocket server
  ‚îú‚îÄ‚îÄ backend_config.json      # Backend configuration
  ‚îú‚îÄ‚îÄ config/
  ‚îÇ   ‚îú‚îÄ‚îÄ gemini_config.py     # Gemini session config
  ‚îÇ   ‚îî‚îÄ‚îÄ prompts.py           # System instructions
  ‚îî‚îÄ‚îÄ core/
      ‚îú‚îÄ‚îÄ websocket_handler.py # Message handling
      ‚îú‚îÄ‚îÄ gemini_client.py     # API session
      ‚îú‚îÄ‚îÄ session.py           # State management
      ‚îî‚îÄ‚îÄ auth.py              # Firebase auth
```

---

## Security Guidelines

### OAuth Tokens
- **NEVER log tokens or fragments**
- Use `[REDACTED]` in logs
- Store in `sessionStorage` (not cookies)
- Validate format (`ya29.` prefix)
- Always use `SecureTokenStorage` class

### Input Validation
- Validate all WebSocket messages
- Check message size (1MB max)
- Validate token format before use
- Rate limit: 10 connections/minute per IP
- CORS: Validate origin headers

### Security Checklist
- [ ] No tokens in logs
- [ ] No sensitive data in error messages
- [ ] Use `textContent` not `innerHTML`
- [ ] Validate all user inputs
- [ ] Rate limiting enabled
- [ ] CORS configured

---

## Configuration

**All settings centralized in config files:**
- `frontend/frontend_config.json` - Frontend configuration
- `backend/backend_config.json` - Backend configuration

**To change settings:** Edit config file, never hardcode values.

### Key Features:

**Voice Settings** (`geminiVoice`):
```json
{
  "enabled": true,
  "voiceName": "Algenib",
  "affectiveDialog": true
}
```
Voices: Puck, Charon, Kore, Fenrir, Aoede, Zubenelgenubi, Orion, Pegasus, Vega, Algenib

**Speaking Video Cycle** (`speakingCycle`):
```json
{
  "enabled": true,
  "initialForwardDuration": 3.0,
  "reverseDuration": 2.0,
  "forwardDuration": 2.0
}
```

---

## Key Modules

### Avatar Video System
- States: `idle`, `listening`, `speaking`, `dancing`, `goodbye`
- State-based video playback
- Speaking cycle: forward ‚Üí reverse/forward loop

### WebSocket Flow
1. Frontend ‚Üí Backend (WebSocket)
2. Backend ‚Üí Gemini API (with API key)
3. Bidirectional streaming
4. Backend = secure proxy (adds auth, rate limiting)

### Audio Pipeline
- Input: 16kHz PCM16 ‚Üí Gemini
- Output: 24kHz PCM16 ‚Üê Gemini
- Native audio streaming (low latency)
- AudioWorklet for processing

---

## Common Tasks

### Adding a New Feature
1. Check if config option needed ‚Üí add to config file
2. Create manager class if complex (`FeatureManager`)
3. Initialize in `initializeConfigDependentComponents()`
4. Wire up UI in `index.html` and handlers in `app.js`
5. Test thoroughly
6. **DO NOT create summary docs**

### Fixing a Bug
1. Identify root cause
2. Fix the code
3. Test the fix
4. Commit with clear message
5. **DO NOT create fix summary document**

### Adding Configuration
1. Add to config file with sensible default
2. Access via configuration loading
3. Document in code comments if complex

---

## Git Workflow

### Commit Messages
```
Format: <type>: <description>

Types:
  feat:     New feature
  fix:      Bug fix
  refactor: Code refactoring
  perf:     Performance improvement
  security: Security fix
  chore:    Maintenance task
  docs:     Documentation only

Example:
  security: remove token logging from backend
  feat: add dance mode with function calling
  fix: resolve WebSocket reconnection issue
```

### What to Commit
- ‚úÖ Code changes
- ‚úÖ Configuration updates
- ‚úÖ Test files
- ‚ùå Summary documents or reports
- ‚ùå Temporary diagnostic files
- ‚ùå Personal notes

---

## File Naming Conventions

- Configuration: `frontend_config.json`, `backend_config.json`, `.env`
- Managers: `*-manager.js` (kebab-case)
- Tests: `test_*.py`, `*_test.js`
- Batch files: `UPPERCASE.bat`
- Documentation: `UPPERCASE.md` (only essential docs)

---

## Dependencies

### Backend (Python)
```
google-genai>=1.51.0
websockets>=12.0
fastapi>=0.104.0
```

### Frontend (JavaScript)
- Material Design 3 Web Components (CDN)
- No build step, runs in browser

---

## Environment Variables

```bash
# Backend (Cloud Run)
BACKEND_HOST=0.0.0.0
BACKEND_PORT=8080
DEBUG=false
REQUIRE_AUTH=false
FIREBASE_PROJECT_ID=avatar-478217  # CRITICAL - see deployment guide

# Secrets (Secret Manager)
GEMINI_API_KEY=<from-secret-manager>
```

---

## Video Files

Located in `media/video/`:
- `idle.webm` - Idle state
- `talking.webm` - Speaking state
- `dance.webm` - Dance mode
- `see-ya.webm` - Goodbye animation

**Customization:** Update paths in `frontend_config.json` ‚Üí `video.sources`

---

## Testing

### Manual Testing
```bash
# Start backend
python backend/main.py

# Start frontend
cd frontend && python -m http.server 8000

# Or use quick start
START.bat
```

### Test Checklist
- [ ] Backend starts without errors
- [ ] Frontend loads, no console errors
- [ ] Avatar video shows idle state
- [ ] Connection flow works
- [ ] Audio input/output functional
- [ ] No token leaks in logs
- [ ] Closed captions display correctly

---

## Quick Reference

### Start Development
```bash
START.bat  # Auto-starts backend and frontend
```

### Check Backend Status
```bash
netstat -ano | findstr :8080
```

### View Logs
- Backend: Terminal where `python backend/main.py` runs
- Frontend: Browser DevTools Console (F12)

---

## Remember

1. **Never create summary documents** for routine work
2. **Always use official SDK methods** - verify before implementing
3. **Use config files** for all settings (frontend_config.json, backend_config.json)
4. **Test thoroughly** after changes
5. **Keep it simple** - don't over-engineer
6. **Security first** - no token logging ever
7. **Model name is sacred** - never change from gemini-2.5-flash-native-audio-preview-09-2025

---

**Deployment & Architecture:** See `CLAUDE_DEPLOYMENT_GUIDE.md` for:
- Complete cloud infrastructure inventory
- Deployment workflows (manual and automatic)
- Troubleshooting procedures
- Function calling implementation patterns
- Emergency rollback procedures
